EventBusClass=Class.extend({listeners:{},addEventListener:function(a,b,d){for(var c=[],e=arguments.length,f=0;f<e;f++)c.push(arguments[f]);c=3<c.length?c.splice(3,c.length-1):[];"undefined"!=typeof this.listeners[a]?this.listeners[a].push({scope:d,callback:b,args:c}):this.listeners[a]=[{scope:d,callback:b,args:c}]},removeEventListener:function(a,b,d){if("undefined"!=typeof this.listeners[a]){for(var c=this.listeners[a].length,e=[],f=0;f<c;f++){var g=this.listeners[a][f];g.scope==d&&g.callback==b||
e.push(g)}this.listeners[a]=e}},hasEventListener:function(a,b,d){if("undefined"!=typeof this.listeners[a]){var c=this.listeners[a].length;if(void 0===b&&void 0===d)return 0<c;for(var e=0;e<c;e++){var f=this.listeners[a][e];if(f.scope==d&&f.callback==b)return!0}}return!1},dispatch:function(a,b){for(var d={type:a,target:b},c=[],e=arguments.length,f=0;f<e;f++)c.push(arguments[f]);c=2<c.length?c.splice(2,c.length-1):[];c=[d].concat(c);if("undefined"!=typeof this.listeners[a])for(d=this.listeners[a].length,
f=0;f<d;f++)if((e=this.listeners[a][f])&&e.callback){var g=c.concat(e.args);e.callback.apply(e.scope,g)}},getEvents:function(){var a="",b;for(b in this.listeners)for(var d=this.listeners[b].length,c=0;c<d;c++)var e=this.listeners[b][c],a=a+(e.scope&&e.scope.className?e.scope.className:"anonymous"),a=a+(" listen for '"+b+"'\n");return a}});ConnectionClass=EventBusClass.extend({token:null,game_url:null,game_key:null,me:null,data:{users:[]},socket:null,channel:null,initialize:function(){window.onbeforeunload=function(){connections.sendMessage("/closed");connections.socket.close()};connections.openChannel(connections.token)},sendMessage:function(a,b){a+="?g="+connections.game_key+"&u="+connections.me;b&&(a+="&"+b);var d=new XMLHttpRequest;d.open("POST",a,!0);d.send()},onOpened:function(){connections.sendMessage("/opened")},onMessage:function(a){try{newState=
JSON.parse(a.data)}catch(b){console.log("onMessage : Error parsing"),newState=""}newState&&(newState.closed?(connections.data.closed=newState.closed,connections.dispatch("onClose")):(connections.data.users[0]=newState.user1,connections.data.users[1]=newState.user2,connections.data.users[2]=newState.user3,connections.data.users[3]=newState.user4,connections.data.machine=newState.machine,connections.data.active=newState.active,connections.data.press=newState.press,connections.data.accuracy=newState.accuracy,
connections.data.lose=newState.lose,connections.data.state=newState.state,console.log("STATE : "+newState.state),connections.dispatch("onMessage")))},onError:function(a){alert("Error: "+JSON.parse(a.data))},onClose:function(a){alert("Close: "+JSON.parse(a.data))},openChannel:function(a){connections.channel=new goog.appengine.Channel(a);connections.socket=connections.channel.open({onopen:connections.onOpened,onmessage:connections.onMessage,onerror:connections.onError,onclose:connections.onClose});
connections.socket.onopen=connections.onOpened;connections.socket.onmessage=connections.onMessage;connections.socket.onclose=connections.onClose}});connections=new ConnectionClass;var INIT=0,READY=1,PLAY_STARTGAME=2,PLAY_SELECT=3,PLAY_MOVE=4,PLAY_PLACE=5,CHECK_PLACE=6,LOSE=8,MACHINE_PLAYERSELECT="[ACTIVE]'s turn. Select a block with your pad and press OK when done.",MACHINE_PLAYERMOVE="Move your block and release it from the block tower without dropping any other block.",MACHINE_PLAYERPLACE="Good! Now select a position to place your block and pass the buck to the next one.",MACHINE_CHECKPLACE="Stability checking...",PLAYER_WAIT="Wait for your turn",PLAYER_SELECT="Select a block",
PLAYER_MOVE="Remove it from the block tower",PLAYER_PLACE="Now place it over the top",PLAYER_TURN="[ACTIVE] turn",PLAYER_CHECKPLACE="Checking...",PLAYER_LOSE="Oh no, you have lost!",COLOR_RED=11080981,COLOR_GREEN=3909909,COLOR_BLUE=1401257,COLOR_YELLOW=15182852,COLOR_GRAY=7829367,COLOR_DARKGRAY=4144184,COLOR_BLOCKS=[COLOR_RED,COLOR_GREEN,COLOR_BLUE,COLOR_YELLOW],FINAL_SENTENCE1="[ACTIVE] has made a wrong move and the tower master has drop him out from Kujenga Pamoja hall of fame.<br/><br/>Anyway, you have made it up to [FLOOR] floors. <br/><br/>You think you can beat this mark? Let's see what you got!",
FINAL_SENTENCE2="[ACTIVE] I think you need a little practice to beat [FLOOR] floors.<br/><br/>What do you think? It's building time so let's do it!",FINAL_SENTENCE3="Great!! You might be proud of reaching [FLOOR] floors, but that's not a mark for true Kujenga warriors. <br/><br/>Do you have what it takes? So play again and beat your mark!",FINAL_SENTENCE4="[FLOOR] floors could be a good mark for a trainee architect, but if you want to be a true Kujenga master you need something more. <br/><br/>Let's do it again and build the empire state of Kujenga's towers!",
FINAL_SENTENCES=[FINAL_SENTENCE1,FINAL_SENTENCE2,FINAL_SENTENCE3,FINAL_SENTENCE4];PlayerClass=Class.extend({playerButtonKeys:{btnUp:0,btnLeft:1,btnDown:2,btnRight:3,btnOK:4},stateDict:[],start:function(){for(var a=Object.keys(player.playerButtonKeys),b=0,d=a.length;b<d;b++)$("#"+a[b]).mousedown(player.press),TweenMax.set("#"+a[b],{scaleX:0,scaleY:0});$("#btnAccurate").click(player.clickAccurate);connections.addEventListener("onMessage",player.onMessage);player.stateDict[PLAY_STARTGAME]=player.onStartGame;player.stateDict[PLAY_MOVE]=player.onMove;player.stateDict[PLAY_PLACE]=player.onPlace;
player.stateDict[READY]=player.hideButtons;player.stateDict[CHECK_PLACE]=player.onCheckPlace;player.stateDict[LOSE]=player.onLoose},press:function(a){a.preventDefault();a="sender="+connections.me+"&press="+player.playerButtonKeys[a.currentTarget.id]+"&accuracy="+$("#btnAccurate").hasClass("selected");connections.sendMessage("/pressed",a)},onMessage:function(){if(null!=player.stateDict[connections.data.state])player.stateDict[connections.data.state]()},onStartGame:function(){connections.data.active==
connections.me?($("h1").css("fontSize","30px"),$("h1").text(PLAYER_SELECT),player.showButtons(),connections.sendMessage("/activated")):$("h1").text()!=PLAYER_WAIT&&(player.hideButtons(),$("h1").css("fontSize","60px"),$("h1").text(PLAYER_WAIT))},onMove:function(){connections.data.active==connections.me&&$("h1").text()!=PLAYER_MOVE&&($("h1").text(PLAYER_MOVE),TweenMax.to("#btnOK",0.5,{scaleX:0,scaleY:0,autoAlpha:!0,ease:"Power3.easeOut",overwrite:1}))},onPlace:function(){connections.data.active==connections.me&&
$("h1").text()!=PLAYER_PLACE&&($("h1").text(PLAYER_PLACE),TweenMax.to("#btnOK",0.5,{scaleX:1,scaleY:1,autoAlpha:!0,ease:"Power3.easeOut",overwrite:1}),TweenMax.to("#btnAccurate",0.5,{alpha:1,autoAlpha:!0,ease:"Power3.easeOut",overwrite:1}))},onCheckPlace:function(){connections.data.active==connections.me&&$("h1").text()!=PLAYER_CHECKPLACE&&$("h1").text(PLAYER_CHECKPLACE);player.hideButtons()},onLoose:function(){connections.data.active==connections.me&&$("h1").text()!=PLAYER_LOSE&&$("h1").text(PLAYER_LOSE);
player.hideButtons()},hideButtons:function(){if($("#playerButtons").hasClass("active")){var a,b,d=Object.keys(player.playerButtonKeys);$("#playerButtons").removeClass("active");a=0;for(b=d.length;a<b;a++)TweenMax.to("#"+d[a],0.5,{scaleX:0,scaleY:0,ease:"Power3.easeOut",overwrite:1});TweenMax.to("#btnAccurate",0.5,{alpha:0,ease:"Power3.easeOut",overwrite:1})}},showButtons:function(){if(!$("#playerButtons").hasClass("active")){var a,b,d=Object.keys(player.playerButtonKeys);$("#playerButtons").addClass("active");
a=0;for(b=d.length;a<b;a++)TweenMax.to("#"+d[a],0.5,{scaleX:1,scaleY:1,autoAlpha:!0,ease:"Power3.easeOut",overwrite:1});$("#btnAccurate").removeClass("selected")}},clickAccurate:function(a){a.preventDefault();$(this).toggleClass("selected")}});var player=new PlayerClass;
