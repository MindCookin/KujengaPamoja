THREE.OrbitControls=function(a,b){function d(){return 2*Math.PI/60/60*f.autoRotateSpeed}function c(a){!1!==f.enabled&&(a.preventDefault(),k===h.ROTATE?(p.set(a.clientX,a.clientY),q.subVectors(p,r),f.rotateLeft(2*Math.PI*q.x/u*f.userRotateSpeed),f.rotateUp(2*Math.PI*q.y/u*f.userRotateSpeed),r.copy(p)):k===h.ZOOM?(s.set(a.clientX,a.clientY),v.subVectors(s,t),0<v.y?f.zoomIn():f.zoomOut(),t.copy(s)):k===h.PAN&&f.pan(new THREE.Vector3(-(a.movementX||a.mozMovementX||a.webkitMovementX||0),a.movementY||a.mozMovementY||
a.webkitMovementY||0,0)))}function e(a){!1!==f.enabled&&!1!==f.userRotate&&(document.removeEventListener("mousemove",c,!1),document.removeEventListener("mouseup",e,!1),k=h.NONE)}function g(a){if(!1!==f.enabled&&!1!==f.userZoom){var b=0;a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);0<b?f.zoomOut():f.zoomIn()}}this.object=a;this.domElement=void 0!==b?b:document;this.enabled=!0;this.center=new THREE.Vector3;this.userZoom=!0;this.userZoomSpeed=1;this.userRotate=!0;this.userRotateSpeed=1;this.userPan=
!0;this.userPanSpeed=2;this.autoRotate=!1;this.autoRotateSpeed=2;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.minDistance=0;this.maxDistance=Infinity;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var f=this,u=1800,r=new THREE.Vector2,p=new THREE.Vector2,q=new THREE.Vector2,t=new THREE.Vector2,s=new THREE.Vector2,v=new THREE.Vector2,l=0,m=0,n=1,w=new THREE.Vector3,h={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},k=h.NONE,x={type:"change"};this.rotateLeft=function(a){void 0===a&&(a=d());m-=a};this.rotateRight=
function(a){void 0===a&&(a=d());m+=a};this.rotateUp=function(a){void 0===a&&(a=d());l-=a};this.rotateDown=function(a){void 0===a&&(a=d());l+=a};this.zoomIn=function(a){void 0===a&&(a=Math.pow(0.95,f.userZoomSpeed));n/=a};this.zoomOut=function(a){void 0===a&&(a=Math.pow(0.95,f.userZoomSpeed));n*=a};this.pan=function(a){a.transformDirection(this.object.matrix);a.multiplyScalar(f.userPanSpeed);this.object.position.add(a);this.center.add(a)};this.update=function(){var a=this.object.position,b=a.clone().sub(this.center),
c=Math.atan2(b.x,b.z),e=Math.atan2(Math.sqrt(b.x*b.x+b.z*b.z),b.y);this.autoRotate&&this.rotateLeft(d());var c=c+m,e=e+l,e=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,e)),e=Math.max(1E-6,Math.min(Math.PI-1E-6,e)),f=b.length()*n,f=Math.max(this.minDistance,Math.min(this.maxDistance,f));b.x=f*Math.sin(e)*Math.sin(c);b.y=f*Math.cos(e);b.z=f*Math.sin(e)*Math.cos(c);a.copy(this.center).add(b);this.object.lookAt(this.center);l=m=0;n=1;0<w.distanceTo(this.object.position)&&(this.dispatchEvent(x),
w.copy(this.object.position))};this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1);this.domElement.addEventListener("mousedown",function(a){!1!==f.enabled&&!1!==f.userRotate&&(a.preventDefault(),0===a.button&&!0===f.userRotate?(k=h.ROTATE,r.set(a.clientX,a.clientY)):1===a.button&&!0===f.userZoom?(k=h.ZOOM,t.set(a.clientX,a.clientY)):2===a.button&&!0===f.userPan&&(k=h.PAN),document.addEventListener("mousemove",c,!1),document.addEventListener("mouseup",e,!1))},!1);this.domElement.addEventListener("mousewheel",
g,!1);this.domElement.addEventListener("DOMMouseScroll",g,!1);this.domElement.addEventListener("keydown",function(a){if(!1!==f.enabled&&!1!==f.userPan)switch(a.keyCode){case f.keys.UP:f.pan(new THREE.Vector3(0,1,0));break;case f.keys.BOTTOM:f.pan(new THREE.Vector3(0,-1,0));break;case f.keys.LEFT:f.pan(new THREE.Vector3(-1,0,0));break;case f.keys.RIGHT:f.pan(new THREE.Vector3(1,0,0))}},!1)};THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);SoundManager=Class.extend({clips:{},enabled:!0,_context:null,_mainNode:null,create:function(){try{sndManager._context=new webkitAudioContext}catch(a){}sndManager._context&&(sndManager._mainNode=sndManager._context.createGainNode(0),sndManager._mainNode.connect(sndManager._context.destination))},loadAsync:function(a,b){if(!sndManager._context)return!1;if(this.clips[a])return b(this.clips[a].s),this.clips[a].s;var d={s:new Sound,b:null,l:!1};this.clips[a]=d;d.s.path=a;var c=new XMLHttpRequest;c.open("GET",
a,!0);c.responseType="arraybuffer";c.onload=function(){sndManager._context.decodeAudioData(c.response,function(a){d.b=a;d.l=!0;b(d.s)},function(a){console.log("Failed to load sound")})};c.send();return d.s},toggleMute:function(){sndManager._context&&(sndManager._mainNode.gain.value=0===sndManager._mainNode.gain.value?1:0)},stopAll:function(){sndManager._context&&(sndManager._mainNode.disconnect(),sndManager._mainNode=sndManager._context.createGainNode(0),sndManager._mainNode.connect(sndManager._context.destination))},
playSound:function(a,b){if(!sndManager._context||!sndManager.enabled)return!1;var d=!1,c=0.2;b&&(b.looping&&(d=b.looping),b.volume&&(c=b.volume));var e=this.clips[a];if(null===e||!1===e.l)return!1;var g=null,g=sndManager._context.createBufferSource();g.buffer=e.b;g.gain.value=c;g.loop=d;g.connect(sndManager._mainNode);g.noteOn(0);return!0},playSoundInstance:function(a,b,d){sndManager.loadAsync(a,function(a){a.play(b,d)})}});
Sound=Class.extend({path:"",play:function(a,b){b||(b=1);sndManager.playSound(this.path,{looping:a,volume:b})}});var sndManager=new SoundManager;EventBusClass=Class.extend({listeners:{},addEventListener:function(a,b,d){for(var c=[],e=arguments.length,g=0;g<e;g++)c.push(arguments[g]);c=3<c.length?c.splice(3,c.length-1):[];"undefined"!=typeof this.listeners[a]?this.listeners[a].push({scope:d,callback:b,args:c}):this.listeners[a]=[{scope:d,callback:b,args:c}]},removeEventListener:function(a,b,d){if("undefined"!=typeof this.listeners[a]){for(var c=this.listeners[a].length,e=[],g=0;g<c;g++){var f=this.listeners[a][g];f.scope==d&&f.callback==b||
e.push(f)}this.listeners[a]=e}},hasEventListener:function(a,b,d){if("undefined"!=typeof this.listeners[a]){var c=this.listeners[a].length;if(void 0===b&&void 0===d)return 0<c;for(var e=0;e<c;e++){var g=this.listeners[a][e];if(g.scope==d&&g.callback==b)return!0}}return!1},dispatch:function(a,b){for(var d={type:a,target:b},c=[],e=arguments.length,g=0;g<e;g++)c.push(arguments[g]);c=2<c.length?c.splice(2,c.length-1):[];c=[d].concat(c);if("undefined"!=typeof this.listeners[a])for(d=this.listeners[a].length,
g=0;g<d;g++)if((e=this.listeners[a][g])&&e.callback){var f=c.concat(e.args);e.callback.apply(e.scope,f)}},getEvents:function(){var a="",b;for(b in this.listeners)for(var d=this.listeners[b].length,c=0;c<d;c++)var e=this.listeners[b][c],a=a+(e.scope&&e.scope.className?e.scope.className:"anonymous"),a=a+(" listen for '"+b+"'\n");return a}});ConnectionClass=EventBusClass.extend({token:null,game_url:null,game_key:null,me:null,data:{users:[]},socket:null,channel:null,initialize:function(){window.onbeforeunload=function(){connections.sendMessage("/closed");connections.socket.close()};connections.openChannel(connections.token)},sendMessage:function(a,b){a+="?g="+connections.game_key+"&u="+connections.me;b&&(a+="&"+b);var d=new XMLHttpRequest;d.open("POST",a,!0);d.send()},onOpened:function(){connections.sendMessage("/opened")},onMessage:function(a){try{newState=
JSON.parse(a.data)}catch(b){console.log("onMessage : Error parsing"),newState=""}newState&&(newState.closed?(connections.data.closed=newState.closed,connections.dispatch("onClose")):(connections.data.users[0]=newState.user1,connections.data.users[1]=newState.user2,connections.data.users[2]=newState.user3,connections.data.users[3]=newState.user4,connections.data.machine=newState.machine,connections.data.active=newState.active,connections.data.press=newState.press,connections.data.accuracy=newState.accuracy,
connections.data.lose=newState.lose,connections.data.state=newState.state,console.log("STATE : "+newState.state),connections.dispatch("onMessage")))},onError:function(a){alert("Error: "+JSON.parse(a.data))},onClose:function(a){alert("Close: "+JSON.parse(a.data))},openChannel:function(a){connections.channel=new goog.appengine.Channel(a);connections.socket=connections.channel.open({onopen:connections.onOpened,onmessage:connections.onMessage,onerror:connections.onError,onclose:connections.onClose});
connections.socket.onopen=connections.onOpened;connections.socket.onmessage=connections.onMessage;connections.socket.onclose=connections.onClose}});connections=new ConnectionClass;GameSceneClass=Class.extend({CUBE_DIMENSIONS:{w:25,h:15,d:75},VIEWPORT_DIMENSIONS:{w:0,h:0},container:null,camera:null,cameraControls:null,scene:null,renderer:null,spotLight:null,fixedDirectionalLight:null,pointLight:null,stats:null,arrows:null,ground:null,texture:null,actualSelection:{floor:0,line:0},arrowsChildren:[],blocksGrid:[],allBlocks:[],actualObject:null,checkSimulation:!0,initialObjects:20,start:function(){var a,b,d,c;gameScene.container=document.getElementById("game_wrapper");try{gameScene.renderer=
new THREE.WebGLRenderer({antialias:!0,sortObjects:!1,shadowMapEnabled:!0,shadowMapType:THREE.PCFShadowMap})}catch(e){alert("Three.js WebGLRenderer is not supported on your browser. Please open Kujenga Pamonga on Google Chrome to see the full experience.");return}gameScene.renderer.sortObjects=!1;gameScene.renderer.setSize(gameScene.VIEWPORT_DIMENSIONS.w,gameScene.VIEWPORT_DIMENSIONS.h);gameScene.renderer.shadowMapEnabled=!0;gameScene.renderer.shadowMapType=THREE.PCFShadowMap;gameScene.container.appendChild(gameScene.renderer.domElement);
gameScene.camera=new THREE.PerspectiveCamera(50,gameScene.VIEWPORT_DIMENSIONS.w/gameScene.VIEWPORT_DIMENSIONS.h,1,1E4);gameScene.camera.position.set(150,180,200);gameScene.resetView();gameScene.cameraControls.autoRotate=!0;gameScene.cameraControls.userRotate=gameScene.cameraControls.userPan=gameScene.cameraControls.userZoom=!1;gameScene.scene=new Physijs.Scene;c=new THREE.HemisphereLight(16777215,COLOR_YELLOW,0.6);gameScene.scene.add(c);c=new THREE.DirectionalLight(16777215,1.5);c.position.copy(gameScene.camera.position);
c.position.setZ(200);c.castShadow=!0;c.shadowCameraNear=200;c.shadowCameraFar=gameScene.camera.far;c.shadowCameraFov=50;c.shadowBias=-1E-7;c.shadowDarkness=0.3;c.shadowMapWidth=2048;c.shadowMapHeight=2048;gameScene.scene.add(c);gameScene.spotLight=new THREE.SpotLight(14540287,1.2);gameScene.scene.add(gameScene.spotLight);gameScene.texture=loader.cachedAssets["/images/metal.jpg"];gameScene.texture.wrapS=gameScene.texture.wrapT=THREE.RepeatWrapping;gameScene.texture.repeat.set(1,0.5);d=new THREE.PlaneGeometry(768,
768);gameScene.ground=new Physijs.BoxMesh(d,new THREE.MeshPhongMaterial({map:gameScene.texture,ambient:197379,color:10311170,specular:39168,shininess:10,shading:THREE.SmoothShading}));gameScene.ground.material.ambient=gameScene.ground.material.color;gameScene.ground.name="ground";gameScene.ground.rotation.x=-90*Math.PI/180;gameScene.ground.receiveShadow=!0;gameScene.ground.__dirtyPosition=!0;gameScene.scene.add(gameScene.ground);b=[{x:384,y:0,z:0,rX:-90*Math.PI/180,rY:-90*Math.PI/180,rZ:0,color:COLOR_RED},
{x:-384,y:0,z:0,rX:-90*Math.PI/180,rY:90*Math.PI/180,rZ:0,color:COLOR_GREEN},{x:0,y:0,z:-384,rX:0,rY:0,rZ:-90*Math.PI/180,color:COLOR_BLUE},{x:0,y:0,z:384,rX:0,rY:180*Math.PI/180,rZ:90*Math.PI/180,color:COLOR_YELLOW}];for(c=0;4>c;c++)new THREE.PlaneGeometry(768,384),a=new Physijs.BoxMesh(d,new THREE.MeshPhongMaterial({map:gameScene.texture,ambient:197379,color:b[c].color,specular:39168,shininess:10,shading:THREE.SmoothShading})),a.position.y=384,a.material.ambient=197379,a.position.set(b[c].x,b[c].y,
b[c].z),a.rotation.set(b[c].rX,b[c].rY,b[c].rZ),a.receiveShadow=!0,a.__dirtyPosition=!0,gameScene.scene.add(a);d=new THREE.CubeGeometry(gameScene.CUBE_DIMENSIONS.w,gameScene.CUBE_DIMENSIONS.h,gameScene.CUBE_DIMENSIONS.d);for(c=0;c<gameScene.initialObjects;c++)b=COLOR_BLOCKS[Math.floor(Math.random()*COLOR_BLOCKS.length)],material=Physijs.createMaterial(new THREE.MeshPhongMaterial({map:gameScene.texture,metal:!0,ambient:197379,color:b,specular:39168,shininess:10,shading:THREE.SmoothShading}),0.4,0.1),
a=new Physijs.BoxMesh(d,material),a.material.transparent=!1,a.material.opacity=1,a.originalColor=b,a.addEventListener("collision",gameScene.collideBlocks),a.castShadow=!0,a.receiveShadow=!0,gameScene.scene.add(a),gameScene.allBlocks.push(a);gameScene.actualObject=gameScene.allBlocks[0];gameScene.resetBlocks();gameScene.stats=new Stats;gameScene.stats.domElement.style.position="absolute";gameScene.stats.domElement.style.top="0px";gameScene.arrows=new THREE.Object3D;b=new THREE.CylinderGeometry(0,4,
10,10);d=[{x:gameScene.CUBE_DIMENSIONS.w,y:0,z:0,rX:0,rY:0,rZ:-90*Math.PI/180,color:COLOR_RED},{x:-gameScene.CUBE_DIMENSIONS.w,y:0,z:0,rX:0,rY:0,rZ:90*Math.PI/180,color:COLOR_GREEN},{x:0,y:0,z:-gameScene.CUBE_DIMENSIONS.d/2-10,rX:-90*Math.PI/180,rY:0,rZ:0,color:COLOR_BLUE},{x:0,y:0,z:gameScene.CUBE_DIMENSIONS.d/2+10,rX:90*Math.PI/180,rY:0,rZ:0,color:COLOR_YELLOW},{x:0,y:gameScene.CUBE_DIMENSIONS.h,z:0,rX:0,rY:0,rZ:0,color:COLOR_BLUE},{x:0,y:-gameScene.CUBE_DIMENSIONS.h,z:0,rX:Math.PI,rY:0,rZ:0,color:COLOR_YELLOW}];
for(c=0;6>c;c++)a=new THREE.Mesh(b,new THREE.MeshLambertMaterial({color:d[c].color})),a.position.x=d[c].x,a.position.y=d[c].y,a.position.z=d[c].z,a.rotation.x=d[c].rX,a.rotation.y=d[c].rY,a.rotation.z=d[c].rZ,gameScene.arrowsChildren.push(a),gameScene.arrows.add(a);$(window).resize(gameScene.resize);gameScene.resize()},resize:function(){gameScene.VIEWPORT_DIMENSIONS={w:$("#game_wrapper").width(),h:$("#game_wrapper").height()};gameScene.camera.aspect=gameScene.VIEWPORT_DIMENSIONS.w/gameScene.VIEWPORT_DIMENSIONS.h;
gameScene.camera.updateProjectionMatrix();gameScene.renderer.setSize(gameScene.VIEWPORT_DIMENSIONS.w,gameScene.VIEWPORT_DIMENSIONS.h)},reset:function(){gameScene.cameraControls.autoRotate=!0;gameScene.cameraControls.userZoom=gameScene.cameraControls.userRotate=!0;gameScene.resetBlocks()},resetBlocks:function(){var a,b,d,c;gameScene.blocksGrid=[];for(c=0;c<gameScene.initialObjects;c++)b=Math.floor(c/3),d=Math.floor(c%3),a=gameScene.allBlocks[c],a.position.x=0===b%2?d*gameScene.CUBE_DIMENSIONS.w-1.5*
gameScene.CUBE_DIMENSIONS.w:-gameScene.CUBE_DIMENSIONS.w/2,a.position.y=gameScene.CUBE_DIMENSIONS.h/2+1*gameScene.CUBE_DIMENSIONS.h*b,a.position.z=0===b%2?0:d*gameScene.CUBE_DIMENSIONS.w-gameScene.CUBE_DIMENSIONS.w,a.rotation.x=0,a.rotation.y=0===b%2?0:-Math.PI/2.01,a.rotation.z=0,a.__dirtyPosition=!0,gameScene.scene.add(a),gameScene.blocksGrid[b]||(gameScene.blocksGrid[b]=[]),gameScene.blocksGrid[b][d]=a},render:function(){connections.data.state!=PLAY_PLACE&&gameScene.checkSimulation&&gameScene.scene.simulate(1.5,
5);gameScene.cameraControls.update();gameScene.spotLight.position.copy(gameScene.camera.position);gameScene.renderer.render(gameScene.scene,gameScene.camera);connections.data.state>=PLAY_SELECT&&connections.data.state<=PLAY_PLACE?gameScene.showArrows():gameScene.hideArrows();gameScene.stats.update()},startGame:function(){gameScene.cameraControls.autoRotate=!1;gameScene.cameraControls.userZoom=gameScene.cameraControls.userRotate=!0;gameScene.resetView()},select:function(){gameScene.actualObject=gameScene.blocksGrid[gameScene.actualSelection.floor][gameScene.actualSelection.line];
gameScene.makeTransparent()},move:function(a){if(1===gameScene.actualSelection.floor%2){var b=gameScene.actualObject.rotation.clone();b.normalize();a.cross(b);a.negate()}gameScene.actualObject.setLinearVelocity(a)},place:function(a){if(1===gameScene.actualSelection.floor%2){var b=gameScene.actualObject.rotation.clone();b.normalize();a.cross(b);a.negate()}a.add(gameScene.actualObject.position);gameScene.actualObject.__dirtyPosition=!0;TweenMax.to(gameScene.actualObject.position,0.5,{x:a.x,y:a.y,z:a.z,
onUpdate:function(){gameScene.actualObject.__dirtyPosition=!0}})},resetView:function(){connections.data.users[0]?(TweenMax.to(gameScene.camera,1,{fov:50,onUpdate:function(){gameScene.camera.updateProjectionMatrix()}}),TweenMax.to(gameScene.camera.position,1,{x:-109,y:143,z:200})):(gameScene.camera.fov=50,gameScene.camera.updateProjectionMatrix(),gameScene.camera.position.set(-109,143,200));gameScene.cameraControls=new THREE.OrbitControls(gameScene.camera,gameScene.renderer.domElement);gameScene.cameraControls.autoRotate=
gameScene.cameraControls.userPan=!1;gameScene.cameraControls.userRotate=gameScene.cameraControls.userZoom=!0;gameScene.cameraControls.maxPolarAngle=Math.PI/2.5;gameScene.cameraControls.maxDistance=500;gameScene.cameraControls.minDistance=50;gameScene.cameraControls.center.copy(new THREE.Vector3(0,50,0));gameScene.cameraControls.zoomIn(1)},makeOpaque:function(){var a,b,d,c;gameScene.actualObject&&(gameScene.actualObject.castShadow=!0);a=0;for(d=gameScene.blocksGrid.length;a<d;a++)for(b=0,c=gameScene.blocksGrid[a].length;b<
c;b++)gameScene.blocksGrid[a][b]&&gameScene.blocksGrid[a][b]!=gameScene.actualObject&&(gameScene.blocksGrid[a][b].material.setValues({color:gameScene.blocksGrid[a][b].originalColor}),gameScene.blocksGrid[a][b].material.transparent=!1,gameScene.blocksGrid[a][b].material.opacity=1,gameScene.blocksGrid[a][b].material.map=gameScene.texture,gameScene.blocksGrid[a][b].material.needsUpdate=!0,gameScene.blocksGrid[a][b].castShadow=!0,gameScene.blocksGrid[a][b].receiveShadow=!0)},makeTransparent:function(){var a,
b,d,c;gameScene.actualObject&&(gameScene.actualObject.material.setValues({color:machine.getActiveUserData().color}),gameScene.actualObject.material.ambient=gameScene.actualObject.material.color,gameScene.actualObject.material.transparent=!1,gameScene.actualObject.material.opacity=1,gameScene.actualObject.material.map=null,gameScene.actualObject.material.needsUpdate=!0,gameScene.actualObject.castShadow=!1,gameScene.actualObject.receiveShadow=!0);a=0;for(d=gameScene.blocksGrid.length;a<d;a++)for(b=
0,c=gameScene.blocksGrid[a].length;b<c;b++)gameScene.blocksGrid[a][b]&&gameScene.blocksGrid[a][b]!=gameScene.actualObject&&(gameScene.blocksGrid[a][b].material.setValues({color:COLOR_GRAY}),gameScene.blocksGrid[a][b].material.ambient=gameScene.blocksGrid[a][b].material.color,gameScene.blocksGrid[a][b].material.transparent=!0,gameScene.blocksGrid[a][b].material.opacity=0.5,gameScene.blocksGrid[a][b].material.map=null,gameScene.blocksGrid[a][b].material.needsUpdate=!0,gameScene.blocksGrid[a][b].castShadow=
!1,gameScene.blocksGrid[a][b].receiveShadow=!1);gameScene.renderer.sortObjects=!0},getRandomColor:function(){return 11184810*Math.random()},showArrows:function(){gameScene.arrows.parent&&gameScene.actualObject==gameScene.arrows.parent||gameScene.actualObject.add(gameScene.arrows)},hideArrows:function(){gameScene.arrows.parent&&gameScene.arrows.parent.remove(gameScene.arrows)},showUpDown:function(){gameScene.arrowsChildren[2].parent&&(gameScene.arrows.remove(gameScene.arrowsChildren[2]),gameScene.arrows.remove(gameScene.arrowsChildren[3]),
gameScene.arrows.add(gameScene.arrowsChildren[4]),gameScene.arrows.add(gameScene.arrowsChildren[5]))},showFrontBack:function(){gameScene.arrowsChildren[2].parent||(gameScene.arrows.add(gameScene.arrowsChildren[2]),gameScene.arrows.add(gameScene.arrowsChildren[3]),gameScene.arrows.remove(gameScene.arrowsChildren[4]),gameScene.arrows.remove(gameScene.arrowsChildren[5]))},toggleStats:function(){gameScene.container.contains(gameScene.stats.domElement)?gameScene.container.removeChild(gameScene.stats.domElement):
gameScene.container.appendChild(gameScene.stats.domElement)},collideBlocks:function(){connections.data.state>=PLAY_MOVE&&connections.data.state<=CHECK_PLACE&&sndManager.playSoundInstance("/sounds/hit.mp3",!1,0.2)},placeBlockOnTop:function(){var a=gameScene.blocksGrid[gameScene.blocksGrid.length-1];gameScene.blocksGrid[gameScene.actualSelection.floor].splice(gameScene.actualSelection.line,1);3<=a.length&&gameScene.blocksGrid.push([]);gameScene.blocksGrid[gameScene.blocksGrid.length-1].push(gameScene.actualObject);
gameScene.actualSelection.floor=gameScene.blocksGrid.length-1;gameScene.actualSelection.line=gameScene.blocksGrid[gameScene.blocksGrid.length-1].length-1;var a=gameScene.blocksGrid.length+1,b=new THREE.Vector3,d=new THREE.Vector3,c=new THREE.Vector3;gameScene.actualObject.setAngularFactor(c);gameScene.actualObject.setLinearFactor(c);gameScene.actualObject.setAngularVelocity(c);gameScene.actualObject.setLinearVelocity(c);b.x=0===a%2?1*gameScene.CUBE_DIMENSIONS.w-1.5*gameScene.CUBE_DIMENSIONS.w:-gameScene.CUBE_DIMENSIONS.w/
2;b.y=gameScene.CUBE_DIMENSIONS.h/2+1*gameScene.CUBE_DIMENSIONS.h*a-10;b.z=0===a%2?0:1*gameScene.CUBE_DIMENSIONS.w-gameScene.CUBE_DIMENSIONS.w;d.x=0;d.y=0===a%2?0:Math.PI/2.01;d.z=0;gameScene.checkSimulation=!1;gameScene.actualObject.__dirtyPosition=!0;gameScene.renderer.sortObjects=!0;TweenMax.to(gameScene.actualObject.position,0.5,{x:b.x,y:b.y,z:b.z,onUpdate:function(){gameScene.actualObject.__dirtyPosition=!0;gameScene.renderer.sortObjects=!0}});gameScene.actualObject.__dirtyRotation=!0;TweenMax.to(gameScene.actualObject.rotation,
0.5,{x:d.x,y:d.y,z:d.z,onUpdate:function(){gameScene.actualObject.__dirtyRotation=!0},onComplete:function(){connections.sendMessage("/moveOK");gameScene.checkSimulation=!0}});sndManager.playSoundInstance("/sounds/lift.mp3",!1);TweenMax.to(gameScene.camera.position,1,{x:85,y:b.y+100,z:200});TweenMax.to(gameScene.camera,1,{fov:40,onUpdate:function(){gameScene.camera.updateProjectionMatrix()}})}});var gameScene=new GameSceneClass;GamePlayClass=Class.extend({counter:0,checkedPlace:!1,checkedMove:!1,haveLost:!1,looper:null,center:new THREE.Vector3(0,0,0),start:function(){gameScene.start()},reset:function(){gamePlay.stopAnimate();gameScene.reset();gamePlay.counter=0;gamePlay.checkedPlace=!1;gamePlay.haveLost=!1;gamePlay.checkedMove=!1;setTimeout(gamePlay.animate,500)},onWindowResize:function(){gameScene.resize()},stopAnimate:function(){window.cancelAnimationFrame(gamePlay.looper)},animate:function(){gamePlay.looper=requestAnimationFrame(gamePlay.animate);
gamePlay.checkState();gamePlay.checkLose();gameScene.render()},startGame:function(){gamePlay.counter=0;gamePlay.checkedPlace=!1;gamePlay.haveLost=!1;gamePlay.checkedMove=!1;gameScene.startGame()},handleSelection:function(){switch(connections.data.press){case 0:gameScene.actualSelection.floor++;break;case 1:gameScene.actualSelection.line--;break;case 2:gameScene.actualSelection.floor--;break;case 3:gameScene.actualSelection.line++}gameScene.actualSelection.floor>=gameScene.blocksGrid.length-1?gameScene.actualSelection.floor=
0:0>gameScene.actualSelection.floor&&(gameScene.actualSelection.floor=gameScene.blocksGrid.length-2);var a=gameScene.blocksGrid[gameScene.actualSelection.floor];gameScene.actualSelection.line>=a.length?gameScene.actualSelection.line=0:0>gameScene.actualSelection.line&&(gameScene.actualSelection.line=a.length-1);gameScene.showUpDown();gameScene.select()},handleMove:function(){var a=connections.data.press;if(!gamePlay.checkedMove){var b=new THREE.Vector3;switch(a){case 0:b.z=-30;break;case 1:b.x=-30;
break;case 2:b.z=30;break;case 3:b.x=30}gameScene.showFrontBack();gameScene.move(b)}},handlePlace:function(){var a=connections.data.press,b=connections.data.accuracy;if(!gamePlay.checkedPlace)if(0<=a&&3>=a){var d=new THREE.Vector3;switch(a){case 0:d.z=b?-5:-gameScene.CUBE_DIMENSIONS.w-1;break;case 1:d.x=b?-5:-gameScene.CUBE_DIMENSIONS.w-1;break;case 2:d.z=b?5:gameScene.CUBE_DIMENSIONS.w+1;break;case 3:d.x=b?5:gameScene.CUBE_DIMENSIONS.w+1}gameScene.place(d)}else gameScene.actualObject.setAngularFactor(new THREE.Vector3(1,
1,1)),gameScene.actualObject.setLinearFactor(new THREE.Vector3(1,1,1)),gameScene.actualObject.setAngularVelocity(new THREE.Vector3(0,0,0)),gameScene.actualObject.setLinearVelocity(new THREE.Vector3(0,0,0)),gameScene.actualObject.__dirtyPosition=!1,gameScene.actualObject.__dirtyRotation=!1},checkMove:function(){gamePlay.center.setY(gameScene.actualObject.position.y);var a=gameScene.actualObject.position.distanceTo(gamePlay.center);if(1<gameScene.actualObject.rotation.y&&a>gameScene.CUBE_DIMENSIONS.d+
1||1>gameScene.actualObject.rotation.y&&a>2.5*gameScene.CUBE_DIMENSIONS.w)gamePlay.checkedMove=!0,gameScene.placeBlockOnTop()},checkPlace:function(){0==gamePlay.counter&&(TweenMax.killTweensOf(gameScene.actualObject.position),gameScene.scene.setGravity(new THREE.Vector3(0,-10,0)));gamePlay.counter++;if(!(30>gamePlay.counter)){var a,b,d=gameScene.blocksGrid.length,c,e,g=gameScene.initialObjects;for(a=0;a<d;a++)for(c=gameScene.blocksGrid[a].length,b=0;b<c;b++)(e=gameScene.blocksGrid[a][b])&&e._physijs&&
0===e._physijs.linearVelocity.x&&(0===e._physijs.linearVelocity.y&&0===e._physijs.linearVelocity.z&&0===e._physijs.angularVelocity.x&&0===e._physijs.angularVelocity.y&&0===e._physijs.angularVelocity.z)&&g--;0===g&&(0<gameScene.actualSelection.line&&gameScene.blocksGrid[gameScene.actualSelection.floor][0].position.y<gameScene.actualObject.position.y-5?gamePlay.lose():gamePlay.checkedPlace=!0)}},checkLose:function(){if(!(gamePlay.haveLost||connections.data.state<PLAY_MOVE||connections.data.state>CHECK_PLACE)){var a,
b,d=gameScene.blocksGrid.length,c,e,g;for(a=0;a<d;a++)for(c=gameScene.blocksGrid[a].length,b=0;b<c;b++)if(e=gameScene.blocksGrid[a][b],!gamePlay.haveLost&&(e&&e._physijs)&&!(e==gameScene.actualObject&&connections.data.state<CHECK_PLACE)&&(gamePlay.center.setY(e.position.y),g=e.position.distanceTo(gamePlay.center),1<e.rotation.y&&g>gameScene.CUBE_DIMENSIONS.d||1>e.rotation.y&&g>2.5*gameScene.CUBE_DIMENSIONS.w)){gamePlay.lose();return}}},lose:function(){gameScene.cameraControls.autoRotate=!0;gameScene.cameraControls.userZoom=
gameScene.cameraControls.userRotate=!1;gamePlay.haveLost=!0;connections.sendMessage("/lose")},restart:function(){gamePlay.counter=0;gamePlay.checkedMove=gamePlay.checkedPlace=gamePlay.haveLost=!1;gameScene.actualSelection={floor:0,line:0};gameScene.actualObject=null;connections.sendMessage("/startGame")},checkState:function(){gamePlay.haveLost||(connections.data.state!=PLAY_MOVE||gamePlay.checkedMove||gamePlay.checkMove(),connections.data.state==CHECK_PLACE&&gamePlay.checkedMove&&(gamePlay.checkedPlace?
gamePlay.restart():gamePlay.checkPlace()))}});var gamePlay=new GamePlayClass;var INIT=0,READY=1,PLAY_STARTGAME=2,PLAY_SELECT=3,PLAY_MOVE=4,PLAY_PLACE=5,CHECK_PLACE=6,LOSE=8,MACHINE_PLAYERSELECT="[ACTIVE]'s turn. Select a block with your pad and press OK when done.",MACHINE_PLAYERMOVE="Move your block and release it from the block tower without dropping any other block.",MACHINE_PLAYERPLACE="Good! Now select a position to place your block and pass the buck to the next one.",MACHINE_CHECKPLACE="Stability checking...",PLAYER_WAIT="Wait for your turn",PLAYER_SELECT="Select a block",
PLAYER_MOVE="Remove it from the block tower",PLAYER_PLACE="Now place it over the top",PLAYER_TURN="[ACTIVE] turn",PLAYER_CHECKPLACE="Checking...",PLAYER_LOSE="Oh no, you have lost!",COLOR_RED=11080981,COLOR_GREEN=3909909,COLOR_BLUE=1401257,COLOR_YELLOW=15182852,COLOR_GRAY=7829367,COLOR_DARKGRAY=4144184,COLOR_BLOCKS=[COLOR_RED,COLOR_GREEN,COLOR_BLUE,COLOR_YELLOW],FINAL_SENTENCE1="[ACTIVE] has made a wrong move and the tower master has drop him out from Kujenga Pamoja hall of fame.<br/><br/>Anyway, you have made it up to [FLOOR] floors. <br/><br/>You think you can beat this mark? Let's see what you got!",
FINAL_SENTENCE2="[ACTIVE] I think you need a little practice to beat [FLOOR] floors.<br/><br/>What do you think? It's building time so let's do it!",FINAL_SENTENCE3="Great!! You might be proud of reaching [FLOOR] floors, but that's not a mark for true Kujenga warriors. <br/><br/>Do you have what it takes? So play again and beat your mark!",FINAL_SENTENCE4="[FLOOR] floors could be a good mark for a trainee architect, but if you want to be a true Kujenga master you need something more. <br/><br/>Let's do it again and build the empire state of Kujenga's towers!",
FINAL_SENTENCES=[FINAL_SENTENCE1,FINAL_SENTENCE2,FINAL_SENTENCE3,FINAL_SENTENCE4];MachineClass=Class.extend({playerData:[{name:"Red Player",className:"red",color:COLOR_RED},{name:"Green Player",className:"green",color:COLOR_GREEN},{name:"Blue Player",className:"blue",color:COLOR_BLUE},{name:"Yellow Player",className:"yellow",color:COLOR_YELLOW}],stateScreenDict:[],stateSoundDict:[],stateGameplayDict:[],start:function(){machine.stateSoundDict[PLAY_STARTGAME]={sound:"/sounds/win.mp3",loop:!1,volume:0.5};machine.stateSoundDict[PLAY_SELECT]={sound:"/sounds/pop.mp3",loop:!1,volume:0.4};
machine.stateSoundDict[PLAY_PLACE]={sound:"/sounds/pop.mp3",loop:!1,volume:0.4};machine.stateSoundDict[PLAY_MOVE]={sound:"/sounds/blip.mp3",loop:!1,volume:0.5};machine.stateSoundDict[CHECK_PLACE]={sound:"/sounds/blip.mp3",loop:!1,volume:0.5};machine.stateSoundDict[LOSE]={sound:"/sounds/lifelost.mp3",loop:!1,volume:0.5};machine.stateScreenDict[READY]=machine.onReady;machine.stateScreenDict[PLAY_STARTGAME]=machine.onStartGame;machine.stateScreenDict[PLAY_MOVE]=machine.onMove;machine.stateScreenDict[PLAY_PLACE]=
machine.onPlace;machine.stateScreenDict[CHECK_PLACE]=machine.onCheckPlace;machine.stateScreenDict[LOSE]=machine.onLose;machine.stateGameplayDict[PLAY_STARTGAME]=gamePlay.startGame;machine.stateGameplayDict[PLAY_SELECT]=gamePlay.handleSelection;machine.stateGameplayDict[PLAY_MOVE]=gamePlay.handleMove;machine.stateGameplayDict[PLAY_PLACE]=gamePlay.handlePlace;$(".btnSound").click(machine.clickSound);$(".btnTransparency").click(machine.clickTransparency);$(".btnResetView").click(machine.clickView);$(".btnPlay").click(machine.clickPlay);
$(".btnStats").click(machine.clickStats);$("#game_wrapper").mouseenter(machine.showGameInfo);$("#game_wrapper").mouseleave(machine.hideGameInfo);$(".btnMinify").click(machine.clickMinify);connections.addEventListener("onMessage",machine.onMessageHandler);connections.addEventListener("onClose",machine.onCloseHandler);gamePlay.start();gamePlay.animate();sndManager.playSoundInstance("/sounds/background.mp3",!0);machine.shortenURL();TweenMax.set(".btnTransparency",{alpha:0.5})},onCloseHandler:function(){connections.data.closed&&
machine.checkUserState()},onMessageHandler:function(){machine.setGameplay();machine.setScreen();machine.playSound();machine.checkUserState()},playSound:function(){var a=machine.stateSoundDict[connections.data.state];!a||("/sounds/blip.mp3"==a.sound&&0<connections.data.press||"/sounds/pop.mp3"==a.sound&&0>connections.data.press)||sndManager.playSoundInstance(a.sound,a.loop,a.volume)},setScreen:function(){if(machine.stateScreenDict[connections.data.state])machine.stateScreenDict[connections.data.state]()},
setGameplay:function(){if(machine.stateGameplayDict[connections.data.state])machine.stateGameplayDict[connections.data.state]()},onReady:function(){"none"==$(".btnPlay").css("display")&&(TweenMax.set("#initial_screen .btnPlay",{alpha:0,scaleY:0,display:"block"}),TweenMax.to("#initial_screen .btnPlay",0.5,{alpha:1,scaleY:1,autoAlpha:!0}),TweenMax.set("#initial_screen .startFun",{alpha:0,display:"block"}),TweenMax.to("#initial_screen .startFun",0.5,{alpha:1,autoAlpha:!0}))},onLose:function(){TweenMax.to("#info_screen",
0.5,{scaleX:0,scaleY:0});TweenMax.set("#stats_screen",{scaleX:0,scaleY:0});TweenMax.to("#stats_screen",0.5,{scaleX:1,scaleY:1,autoAlpha:!0});var a=FINAL_SENTENCES[Math.floor(Math.random()*FINAL_SENTENCES.length)],a=a.replace("[ACTIVE]",machine.getActiveUserData().name),a=a.replace("[FLOOR]",gameScene.blocksGrid.length);$("#stats_screen .sentence").html(a);machine.hideGameInfo()},onMove:function(){$("#info_screen p").text(MACHINE_PLAYERMOVE)},onPlace:function(){$("#info_screen p").text(MACHINE_PLAYERPLACE)},
onCheckPlace:function(){$("#info_screen p").text(MACHINE_CHECKPLACE)},onStartGame:function(){$("#info_screen p").text(MACHINE_PLAYERSELECT.replace("[ACTIVE]",machine.getActiveUserData().name));TweenMax.to("#initial_screen",0.5,{scaleX:0,scaleY:0,ease:"Quint.easeIn"});TweenMax.to("#stats_screen",0.5,{scaleX:0,scaleY:0,ease:"Quint.easeIn"});TweenMax.set("#info_screen",{scaleX:0,scaleY:0});TweenMax.to("#info_screen",0.5,{scaleX:1,scaleY:1,ease:"Quint.easeOut",autoAlpha:!0});$("#info_screen").removeClass("red green blue yellow");
$("#info_screen").addClass(machine.getActiveUserData().className);$("#playersSidebar li").each(function(){$(this).hasClass(machine.getActiveUserData().className)?$(this).text(PLAYER_TURN.replace("[ACTIVE]",machine.getActiveUserData().name)):$(this).text(PLAYER_WAIT)});machine.showBackground()},getActiveUserData:function(){switch(connections.data.active){case connections.data.users[0]:return machine.playerData[0];case connections.data.users[1]:return machine.playerData[1];case connections.data.users[2]:return machine.playerData[2];
case connections.data.users[3]:return machine.playerData[3]}},clickPlay:function(a){a.preventDefault();connections.data.state==LOSE?gamePlay.reset():machine.showGameInfo();connections.sendMessage("/startGame")},clickSound:function(a){a.preventDefault();machine.toggleToolsButton($(this));sndManager.toggleMute()},clickStats:function(a){a.preventDefault();machine.toggleToolsButton($(this));gameScene.toggleStats()},clickTransparency:function(a){a.preventDefault();machine.toggleToolsButton($(this));$(this).hasClass("transparent")?
gameScene.makeTransparent():gameScene.makeOpaque()},clickView:function(a){a.preventDefault();gameScene.resetView()},toggleToolsButton:function(a){a.hasClass("transparent")?(TweenMax.to(a,0.3,{alpha:1}),a.removeClass("transparent")):(TweenMax.to(a,0.3,{alpha:0.5}),a.addClass("transparent"))},showGameInfo:function(a){a&&a.preventDefault();connections.data.state>=PLAY_STARTGAME&&connections.data.state<=CHECK_PLACE&&(TweenMax.to("#toolbar",0.3,{alpha:1,autoAlpha:!0}),TweenMax.to("#camera_controls_info",
0.3,{alpha:1,autoAlpha:!0}))},hideGameInfo:function(a){a&&a.preventDefault();TweenMax.to("#toolbar",0.3,{alpha:0});TweenMax.to("#camera_controls_info",0.3,{alpha:0})},showBackground:function(){$("#game_background").removeClass("red green blue yellow");TweenMax.set("#game_background",{alpha:0});$("#game_background").addClass(machine.getActiveUserData().className);TweenMax.to("#game_background",2,{alpha:1,onComplete:function(){$("body").removeClass("red green blue yellow");$("body").addClass(machine.getActiveUserData().className)}})},
checkUserState:function(){var a,b,d;b=connections.data.users;a=0;for(b=b.length;a<b;a++)d=machine.playerData[a].className,""==connections.data.users[a]||$("#playersSidebar ."+d).hasClass("active")?""==connections.data.users[a]&&machine.deactivateUser("#playersSidebar ."+d):machine.activateUser("#playersSidebar ."+d)},activateUser:function(a){$(a+" .tick").css("visibility","visible");TweenMax.to(a,0.5,{marginLeft:-150,onComplete:function(){$(a).addClass("active")}});sndManager.playSoundInstance("/sounds/blip.mp3",
!1)},deactivateUser:function(a){$(a+" .tick").css("visibility","hidden");TweenMax.to(a,0.5,{marginLeft:-200,onComplete:function(){$(a).removeClass("active")}})},shortenURL:function(){$.ajax({url:"https://www.googleapis.com/urlshortener/v1/url?shortUrl=http://goo.gl/fbsS&key=AIzaSyB1Q-_z_lOa8dbdaERT13LnHyDllGoONbs",type:"POST",contentType:"application/json; charset=utf-8",data:'{ longUrl: "'+connections.game_url+'"}',dataType:"json",success:function(a){$(".url").text(a.id);$(".url").attr("href",a.id);
$("#camera_controls_info span").text(a.id)},error:function(a){$(".url").text(connections.game_url);$(".url").attr("href",connections.game_url);$("#camera_controls_info span").text(connections.game_url)}})},clickMinify:function(a){a.preventDefault();$("#info_screen").toggleClass("minified");$("#info_screen").hasClass("minified")?$(this).text("+"):$(this).text("x")}});var machine=new MachineClass;
